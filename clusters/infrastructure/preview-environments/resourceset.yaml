---
apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: gitlab-preview-environments
  namespace: flux-system
spec:
  serviceAccountName: preview-environments
  inputsFrom:
    - apiVersion: fluxcd.controlplane.io/v1
      kind: ResourceSetInputProvider
      name: banterbus-merge-requests
  resources:
    - apiVersion: source.toolkit.fluxcd.io/v1
      kind: GitRepository
      metadata:
        name: "banterbus-mr-<< inputs.id >>"
        namespace: flux-system
        labels:
          preview.flux.dev/enabled: "true"
          preview.flux.dev/project: "<< inputs.project_name >>"
          preview.flux.dev/merge-request: "<< inputs.id >>"
      spec:
        interval: 1m
        url: "<< inputs.clone_url >>"
        ref:
          branch: "<< inputs.branch >>"
        timeout: 60s

    - apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: "banterbus-mr-<< inputs.id >>"
        namespace: "<< inputs.namespace >>"
        annotations:
          event.toolkit.fluxcd.io/preview-url: "https://mr-<< inputs.id >>.dev.banterbus.<< inputs.domain >>"
          event.toolkit.fluxcd.io/branch: "<< inputs.branch >>"
          event.toolkit.fluxcd.io/author: "<< inputs.author >>"
          preview.flux.dev/source-branch: "<< inputs.branch >>"
          preview.flux.dev/target-branch: "<< inputs.target_branch >>"
          preview.flux.dev/gitlab-url: "<< inputs.web_url >>"
        labels:
          preview.flux.dev/enabled: "true"
          preview.flux.dev/project: "<< inputs.project_name >>"
          preview.flux.dev/merge-request: "<< inputs.id >>"
      spec:
        interval: 10m
        path: "./infra/k8s/overlays/preview"
        prune: true
        sourceRef:
          kind: GitRepository
          name: "banterbus-mr-<< inputs.id >>"
          namespace: flux-system
        patches:
          - patch: |
              - op: replace
                path: /spec/template/spec/containers/0/image
                value: "<< inputs.image >>:<< inputs.sha >>"
            target:
              kind: Deployment
              name: banterbus
          - patch: |
              - op: replace
                path: /spec/rules/0/host
                value: "mr-<< inputs.id >>.dev.banterbus.<< inputs.domain >>"
              - op: replace
                path: /spec/tls/0/hosts/0
                value: "mr-<< inputs.id >>.dev.banterbus.<< inputs.domain >>"
              - op: replace
                path: /spec/tls/0/secretName
                value: "banterbus-mr-<< inputs.id >>-tls"
            target:
              kind: Ingress
              name: banterbus
